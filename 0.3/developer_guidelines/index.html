<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Guidelines - Meta-Omics-Toolkit</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <link href="../css/version-select.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Meta-Omics-Toolkit</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../pipeline_configuration/" class="nav-link">Global Pipeline Configuration Settings</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Modules <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../modules/qualityControl/" class="dropdown-item">Quality Control</a>
</li>
                                    
<li>
    <a href="../modules/annotation/" class="dropdown-item">Annotation</a>
</li>
                                    
<li>
    <a href="../modules/assembly/" class="dropdown-item">Assembly</a>
</li>
                                    
<li>
    <a href="../modules/cooccurrence/" class="dropdown-item">Cooccurrence</a>
</li>
                                    
<li>
    <a href="../modules/dereplication/" class="dropdown-item">Dereplication</a>
</li>
                                    
<li>
    <a href="../modules/fragment_recruitment/" class="dropdown-item">Run Fragment Recruitment</a>
</li>
                                    
<li>
    <a href="../modules/magAttributes/" class="dropdown-item">MagAttributes</a>
</li>
                                    
<li>
    <a href="../modules/plasmids/" class="dropdown-item">Plasmids</a>
</li>
                                    
<li>
    <a href="../modules/metabolomics/" class="dropdown-item">Metabolomics</a>
</li>
                                    
<li>
    <a href="../modules/readMapping/" class="dropdown-item">Read Mapping</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Developer <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="./" class="dropdown-item active">Guidelines</a>
</li>
                                    
<li>
    <a href="../pipeline_specification/" class="dropdown-item">Pipeline Specification</a>
</li>
                                    
<li>
    <a href="../module_specification/" class="dropdown-item">Module Specification</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../modules/readMapping/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../pipeline_specification/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#guidelines" class="nav-link">Guidelines</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#commit-and-release-guidelines" class="nav-link">Commit and Release Guidelines</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#testing" class="nav-link">Testing</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#modules" class="nav-link">Modules</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#process" class="nav-link">Process</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#databases" class="nav-link">Databases</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#configuration" class="nav-link">Configuration</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#toolkit-docker-images" class="nav-link">Toolkit Docker Images</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#wiki" class="nav-link">Wiki</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#utils" class="nav-link">Utils</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#database-download" class="nav-link">Database Download</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#polished-variables" class="nav-link">Polished Variables</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#other" class="nav-link">Other</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="guidelines">Guidelines</h1>
<h2 id="commit-and-release-guidelines">Commit and Release Guidelines</h2>
<p>We are using <a href="https://github.com/git-chglog/git-chglog">git-chglog</a> to automatically generate a changelog for the latest released based on our commit messages.
Commit messages should follow the following format:</p>
<div class="highlight"><pre><span></span><code>feat(scope): feature added in the scope
</code></pre></div>
<p>Example:</p>
<div class="highlight"><pre><span></span><code>feat(assembly): megahit added
</code></pre></div>
<p><code>feat</code> can be replaced by one of the formats specified in the options sections of the config file (see example below).
Scope can for example represent a module, a configuration or a specific document.</p>
<p>A new release should be made the following way: </p>
<ol>
<li>
<p>Update pipeline version in the nextflow manifest <code>nextflow.config</code>.</p>
</li>
<li>
<p>Create a release on Github.</p>
</li>
<li>
<p>Run <code>git fetch</code> on the master branch to get the latest tag.</p>
</li>
<li>
<p>Run <code>make changelog</code> and paste the output on the Github release section.</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="versioning">Versioning</h3>
<p>Following <a href="https://semver.org/">semantic versioning</a>, we define the configuration input file and the output folder structure as our public <code>API</code>.
Changes to the version numbers reflect updates to the config or the output folders and files.
The toolkit consists of many modules that can be used in different combinations and
because of this flexibility, we had to come up with a detailed versioning system. We version each module separately, as well as the pipeline itself.</p>
<p>Module MAJOR version numbers are updated when a module-specific input parameter is updated or the output folder or file structure is changed.
All module version numbers can be retrieved by running the toolkit with the <code>wGetModuleVersion</code> entry point and should be reported on the release page. </p>
<p>The module version number is incorporated in the output directory (see <a href="../pipeline_specification/">output specification</a>) 
for easier parsing of the output directory. In the following we give examples when to increment which part of the version identifier:</p>
<p>Given a version number MAJOR.MINOR.PATCH, increment the:</p>
<ul>
<li>MAJOR version when you make incompatible changes, as for example modifying the output structure. A script that was build to parse the output structure must be adapted then.</li>
<li>MINOR version when you add functionality in a backward compatible manner. One example is adding an additional tool to the module. </li>
<li>PATCH version when you make backwards compatible bug fixes. This is necessary when you for example increment the docker container version number that fixes a bug or increases the
    speed of the tool.</li>
</ul>
<p>The pipeline specific version number defined in the manifest part of the nextflow.config should be changed
if either any module specific version number is incremented or any module-independent parameter (e.g. <code>tempdir</code>) or output structure is changed. </p>
<h2 id="testing">Testing</h2>
<p>Tests for local use are specified in the <code>scripts</code> folder. These scripts are also used as part of the continuous integration tests.
If you want to run these scripts locally, you will have to override the paths to the databases you have downloaded:</p>
<p>Examples:
<div class="highlight"><pre><span></span><code>bash<span class="w"> </span>scripts/test_fullPipeline.sh<span class="w">  </span><span class="s2">&quot; --steps.magAttributes.checkm.database=/vol/spool/checkm --steps.magAttributes.gtdb.database=/vol/spool/gtdb/release202 &quot;</span>
bash<span class="w"> </span>scripts/test_fragmentRecruitment.sh<span class="w">  </span><span class="s2">&quot; --steps.fragmentRecruitment.frhit.genomes=test/bins/small/bin.*.fa --steps.fragmentRecruitment.frhit.samples=test/reads/small/reads.tsv &quot;</span>
bash<span class="w"> </span>scripts/test_dereplication.sh<span class="w"> </span><span class="s2">&quot;  --steps.dereplication.pasolli.input=test/bins/small/attributes.tsv &quot;</span>
bash<span class="w"> </span>scripts/test_magAttributes.sh<span class="w"> </span><span class="s2">&quot;  --steps.magAttributes.input=test/bins/small/attributes.tsv &quot;</span>
</code></pre></div></p>
<h3 id="nextflow-versions">Nextflow Versions</h3>
<p>The toolkit is tested against the lowest and highest Nextflow version number specified in VERSIONS.txt.</p>
<h2 id="modules">Modules</h2>
<p>Functionality is structured in modules (assembly, binning, dereplication, .etc). Each module can have multiple workflows.
Every module follows the output definition specified in the <a href="../pipeline_specification/">output specification</a>  document. The name and the version of the
module is specified in the <code>modules</code> section of the <code>nextflow.config</code> file.</p>
<h3 id="workflows">Workflows</h3>
<ol>
<li>
<p>Worfklow names that can not be used directly and are just meant for internal use should start with an underscore.</p>
</li>
<li>
<p>At least every workflow that can be used by other external workflows should contain a short description of the functionality. </p>
</li>
<li>
<p>Workflow names must start with <code>w</code>. </p>
</li>
</ol>
<h2 id="process">Process</h2>
<p>Process names should start <code>p</code>. The in- and output of processes should contain a sample and/or a bin and contig id.
Custom error strategies that do not follow the strategy defined in nextflow.config, should be documented (see Megahit example).</p>
<h3 id="processes-should-publish-process-specific-files">Processes should publish process specific files</h3>
<p>Processes should publish <code>.command.sh</code>, <code>.command.out</code>, <code>.command.log</code> and <code>.command.err</code> files but never <code>.command.run</code>.
In cases where processes process different data but publish it to the same folder these files would be overwritten on every run.
For example when Prokka publishes log files of every genome to the same sample directory.
For that reason these files need to be renamed, so that their names include a unique id (e.g. bin id). 
Please output those files to channel with the following entries and connect this channel to the pDumpLogs process that you can import
from the utils module:</p>
<div class="highlight"><pre><span></span><code><span class="n">include</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pDumpLogs</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="err">&#39;</span><span class="p">..</span><span class="o">/</span><span class="n">utils</span><span class="o">/</span><span class="n">processes</span><span class="err">&#39;</span>

<span class="p">...</span>

<span class="n">tuple</span><span class="w"> </span><span class="nf">env</span><span class="p">(</span><span class="n">FILE_ID</span><span class="p">),</span><span class="w"> </span><span class="n">val</span><span class="p">(</span><span class="s">&quot;${output}&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">val</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="na">LOG_LEVELS</span><span class="p">.</span><span class="na">INFO</span><span class="p">),</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s">&quot;.command.sh&quot;</span><span class="p">),</span><span class="w"> </span><span class="err">\</span>
<span class="w">        </span><span class="n">file</span><span class="p">(</span><span class="s">&quot;.command.out&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s">&quot;.command.err&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">file</span><span class="p">(</span><span class="s">&quot;.command.log&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">emit</span><span class="p">:</span><span class="w"> </span><span class="n">logs</span>
</code></pre></div>
<p>Examples can be viewed in the Checkm and Prokka process.</p>
<h4 id="logs">Logs</h4>
<p>Log files should be stored in the user provided <code>logDir</code> directory.</p>
<h5 id="log-level">Log Level</h5>
<p>Every configuration file must have a <code>logLevel</code> attribute that can have the following values:</p>
<div class="highlight"><pre><span></span><code>ALL = 0  All logs are published
INFO = 1 Just necessary logs are published
</code></pre></div>
<p>These values can be used in the publish dir directive to enable or disable the output of logs.</p>
<div class="highlight"><pre><span></span><code><span class="w">   </span><span class="n">publishDir</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="na">output</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;${params.publishDirMode}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">saveAs</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">getOutput</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="na">runid</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pasolli/mash/sketch&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="err">\</span>
<span class="w">        </span><span class="n">pattern</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{**.out,**.err, **.sh, **.log}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">enabled</span><span class="p">:</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="na">logLevel</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="na">LOG_LEVELS</span><span class="p">.</span><span class="na">ALL</span>
</code></pre></div>
<p>Furthermore the <code>params.LOG_LEVELS.*</code> parameters can be used inside of a process to enable or disable intermediate results for debugging purposes.
In cases where the log is send to the pDumpLogs process (see Process section), you can specify the log level as part of the tuple:</p>
<div class="highlight"><pre><span></span><code>tuple env(FILE_ID), val(&quot;${output}&quot;), val(params.LOG_LEVELS.INFO), file(&quot;.command.sh&quot;), \
        file(&quot;.command.out&quot;), file(&quot;.command.err&quot;), file(&quot;.command.log&quot;), emit: logs
</code></pre></div>
<h3 id="time-limit">Time Limit</h3>
<p>Every process must define a time limit which will never be reached on "normal" execution. This limit is only useful for errors in the execution environment<br />
which could lead to an endless execution of the process.</p>
<p>You can use the setTimeLimit helper method to add a user configurable time limit.</p>
<p>Example:</p>
<div class="highlight"><pre><span></span><code>time Utils.setTimeLimit(params.steps.qc.fastp, params.modules.qc.process.fastp.defaults, params.resources.highmemMedium)
</code></pre></div>
<h2 id="databases">Databases</h2>
<p>If the same database is downloaded during runtime by multiple processes, it takes up an unnecessary ammount of disc space.
One idea is too always use the same place to store these databases. This place should be described in <code>params.databases</code>.
If other processes try to use this databases they can look at <code>params.databases</code> on the current machine. 
If it is present it can be used, if not it should be downloaded. Through this procedure only one copy of each databases is used,
which is space-saving. Links to the actual database should contain the database version number or the date of download.</p>
<h2 id="configuration">Configuration</h2>
<p>Every process should be configurable by providing a parameters string to the tool in the process.
Every module should use the following specification in the configuration file:</p>
<div class="highlight"><pre><span></span><code><span class="nt">steps</span><span class="p">:</span>
<span class="w">  </span><span class="nt">moduleName</span><span class="p">:</span>
<span class="w">    </span><span class="nt">parameter</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">42</span>
<span class="w">    </span><span class="nt">processName</span><span class="p">:</span>
<span class="w">      </span><span class="nt">additionalParams</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="nv"> </span><span class="s">--super-flag</span><span class="nv"> </span><span class="s">&quot;</span>
<span class="w">      </span><span class="nt">timeLimit</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;AUTO&quot;</span>
</code></pre></div>
<p>Please check the process chapter regarding possible values for the time limit attribute.
Additional params can have a string value (like the example above) that is provided to the tool:</p>
<div class="highlight"><pre><span></span><code><span class="n">pProcess</span><span class="w"> </span><span class="p">{</span>

<span class="w">   </span><span class="p">...</span>

<span class="w">  </span><span class="nl">shell</span><span class="p">:</span>
<span class="w">  </span><span class="s">&quot;&quot;&quot;</span>
<span class="s">  supertool !{params.steps.moduleName.processName.parameter}  !{params.steps.moduleName.processName.additionalParams}</span>
<span class="s">  &quot;&quot;&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>The value of the <code>additionalParams</code> key can also be a map if multiple tools are used in the same process:</p>
<div class="highlight"><pre><span></span><code><span class="nt">steps</span><span class="p">:</span>
<span class="w">  </span><span class="nt">moduleName</span><span class="p">:</span>
<span class="w">    </span><span class="nt">parameter</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">42</span>
<span class="w">    </span><span class="nt">processName</span><span class="p">:</span>
<span class="w">      </span><span class="nt">additionalParams</span><span class="p">:</span>
<span class="w">         </span><span class="nt">toolNameA</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="nv"> </span><span class="s">-c</span><span class="nv"> </span><span class="s">84</span><span class="nv">  </span><span class="s">&quot;</span>
<span class="w">         </span><span class="nt">toolNameB</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="nv"> </span><span class="s">--super-flag</span><span class="nv"> </span><span class="s">&quot;</span>
</code></pre></div>
<p><code>parameter</code> fields can hold hardcoded parameters that hold a defined value like a number that should not be a string.
One use case of those parameters is that they can be reused for multiple tools.</p>
<p>Example:</p>
<div class="highlight"><pre><span></span><code>pProcess {

   ...

  shell:
  &quot;&quot;&quot;
  toolNameA --super-specific-number-flag !{params.steps.moduleName.parameter}
  toolNameB --similar-flag-to-toolA !{params.steps.moduleName.parameter} 
  &quot;&quot;&quot;
}
</code></pre></div>
<h3 id="internal-configuration">Internal Configuration</h3>
<p>The <code>_wConfigurePipeline</code> workflow in the main.nf file should be used for setting 
pipeline parameters that are need for fullfilling the user provided configuration.</p>
<p>Example:
Lets assume the user enables the plasmid module. In that case it is mandatory that 
the assembler produces a fastg file independend of the user provided settings of the assembler.
In that case the fastg parameter of any assembler will be set to <code>true</code> by the <code>_wConfigurePipeline</code> method.</p>
<h2 id="toolkit-docker-images">Toolkit Docker Images</h2>
<p>Dockerfiles of Docker images that are build by toolkit developers can be found in the <code>docker</code> directory.
The name of the directory (i.e.: <code>toolkit-python-env</code> in <code>docker/toolkit-python-env</code>) is used for the docker image name. All images belong to the
<a href="https://quay.io/organization/metagenomics">metagenomics</a> quay.io organisation which is owned by the Computational Metagenomics group in Bielefeld.
A docker repository in the <code>metagenomics</code> orginsation must be created by the organisation owner, before the actual image can be build.
The version of the image specified in the <code>VERSION</code> file (i.e. <code>docker/toolkit-python-env/VERSION</code>) is used for the image tag (<code>metagenomics/toolkit-python-env:VERSION</code>).
An image build is only triggered if the version in the VERSION file is updated on the dev or master branch.</p>
<h2 id="wiki">Wiki</h2>
<p>For building the documentation we are using <a href="https://www.mkdocs.org/">mkdocs</a> in combination with <a href="https://squidfunk.github.io/mkdocs-material/">mkdocs-material</a>
and a <a href="https://timvink.github.io/mkdocs-print-site-plugin/index.html">plugin</a> for building static single page html files.
The wiki HTML files are uploaded to S3 storage on pull request merge events in the master and dev branch (see Makefile commands using <code>make help</code>).</p>
<p>You can work on these html files locally by running <code>make dev_wiki</code>. But please note that by build the static html file for upload, the navigation might change.
You can view the final html file by building the html file (see Makefile <code>make help</code>). </p>
<h2 id="utils">Utils</h2>
<p>We do not want to duplicate code and thats why we should store methods in the lib/Utils.groovy file. The Utils class can be used in any module. </p>
<h2 id="database-download">Database Download</h2>
<p>This section explains how a developer is able to implement the database download strategy as explained in the <a href="../pipeline_configuration/#database-input-configuration">user documentation</a>. 
Example implementations can be found in the gtdb, checkm or rgi scripts.</p>
<p>The first step is to check if the user provides an already extracted database: </p>
<div class="highlight"><pre><span></span><code><span class="nv">DB_PATH</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;!{EXTRACTED_DB}&quot;</span><span class="w"> </span><span class="o">]</span>
<span class="k">then</span>
<span class="w">   </span><span class="c1"># Fetch user parameter for not extracted db path and run flock (see next section)</span>
<span class="w">   </span><span class="nv">DB_PATH</span><span class="o">=</span><span class="s2">&quot;not extracted&quot;</span>
<span class="k">else</span>
<span class="w">  </span><span class="c1"># Set variable to extracted db path</span>
<span class="k">fi</span>
</code></pre></div>
<p>Since the download is not directly handled by nextflow and paths to the files need to be downloaded, any file or directory must be
mounted first to the container. For this reason you have to add the <code>setDockerMount</code> function with the database config as input to 
the <code>containerOptions</code> parameter:</p>
<div class="highlight"><pre><span></span><code>containerOptions<span class="w"> </span><span class="s2">&quot; other container options &quot;</span><span class="w"> </span>+<span class="w"> </span>setDockerMount<span class="o">(</span>params.steps?.magAttributes?.checkm?.database<span class="o">)</span>
</code></pre></div>
<h3 id="filesystem-locks">Filesystem locks</h3>
<p>Multiple jobs of the same process (e.g. GTDB) are able to synchronize the download of a database by using filesystem locks.
The download is handled by the <code>concurrentDownload.sh</code> script and should be executed the following way:</p>
<div class="highlight"><pre><span></span><code>flock<span class="w"> </span>LOCK_FILE<span class="w"> </span>concurrentDownload.sh<span class="w"> </span>--output<span class="o">=</span>DATABASE<span class="w"> </span><span class="se">\</span>
<span class="w">           </span>--httpsCommand<span class="o">=</span>COMMAND<span class="w"> </span><span class="se">\</span>
<span class="w">           </span>--localCommand<span class="o">=</span>COMMAND<span class="w"> </span><span class="se">\</span>
<span class="w">           </span>--s3FileCommand<span class="o">=</span>COMMAND<span class="w"> </span><span class="se">\</span>
<span class="w">           </span>--s3DirectoryCommand<span class="o">=</span>COMMAND<span class="w"> </span><span class="se">\</span>
<span class="w">           </span>--s5cmdAdditionalParams<span class="o">=</span>S5CMD_PARAMS<span class="w"> </span><span class="se">\</span>
<span class="w">           </span>--link<span class="o">=</span>LINK<span class="w"> </span><span class="se">\</span>
<span class="w">           </span>--expectedMD5SUM<span class="o">=</span>USER_VERIFIED_DATABASE_MD5SUM
</code></pre></div>
<p>where
  * <code>LOCK_FILE</code> is a file that is used for locking. Processes will check if the file is currently locked before trying to download anything.
    This file should ideally placed in the <code>params.database</code> directory of the specific tool (e.g. !{params.databases}/rgi).</p>
<ul>
<li>
<p><code>DATABASE</code> is the directory that is used for placing the specific database.</p>
</li>
<li>
<p><code>COMMAND</code> is the command used to download and extract the database and to remove it afterwards. 
    (e.g. "wget -O data.tar.gz $DOWNLOAD_LINK &amp;&amp; tar -xvf data.tar.gz ./card.json &amp;&amp; rm data.tar.gz" for the <code>--httpsCommand</code> flag)</p>
</li>
<li>
<p><code>USER_VERIFIED_DATABASE_MD5SUM</code> is the MD5SUM of the <em>extracted</em> database that the user should test manually before executing the pipeline.</p>
</li>
<li>
<p><code>S5CMD_PARAMS</code> allows you to set s5cmd specific parameters. For more information check the s5cmd documentation. </p>
</li>
<li>
<p><code>LINK</code> is the link that will be used to test if the file is accessible by S3, HTTPS or is available via a local path.</p>
</li>
<li>
<p><code>USER_VERIFIED_DATABASE_MD5SUM</code> Before a database is downloaded, the script checks the MD5SUM of an already downloaded database against a user specified one.
     If it does not equal, the script will download the database again.</p>
</li>
</ul>
<h3 id="tests">Tests</h3>
<p>You can test your tool against different database inputs by using the <code>make runDatabaseTest</code> command. You will have to specify multiple databases 
that are accessible via https, S3, local path etc. Please check github actions file for how to run these tests.</p>
<h2 id="polished-variables">Polished Variables</h2>
<p>Sometimes user input variables must be polished before they can used in our code.
Thats why the nextflow config adds a namespace to the params namespace called <code>polished</code>.
For example the params.databases variable must end with a slash in order to be used as part of a docker mount.
Thats why there is a variable <code>params.polished.databases</code> that should be used instead.  </p>
<h2 id="other">Other</h2>
<ol>
<li>
<p>Magic numbers should not be used.</p>
</li>
<li>
<p>Variable, method, workflow, folder and process names should be written in camelcase.</p>
</li>
</ol></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/jquery-3.6.0.min.js"></script>
        <script src="../js/bootstrap.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>
        <script src="../js/version-select.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
